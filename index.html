<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>MathAR</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap');

:root {
  --p: #c4a8ff; --pk: #ff9fd4; --b: #8dd8ff;
  --g: #80ffcc; --o: #ffd080; --bg: #07070f;
  --mono: 'Space Mono', monospace; --sans: 'Syne', sans-serif;
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; user-select:none; }
html,body { width:100%; height:100%; overflow:hidden; background:#000; font-family:var(--sans); }

#video { position:fixed; inset:0; width:100%; height:100%; object-fit:cover; z-index:0; }

/* SPLASH */
#splash {
  position:fixed; inset:0; z-index:300; background:var(--bg);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:1.6rem; padding:2rem; transition:opacity .6s, transform .6s;
}
#splash.out { opacity:0; transform:scale(1.04); pointer-events:none; }
.logo-ring {
  width:76px; height:76px; border-radius:22px;
  border:2px solid var(--p); background:rgba(196,168,255,.06);
  display:flex; align-items:center; justify-content:center;
  font-size:2.2rem; color:var(--p); animation:glow 2.5s ease-in-out infinite;
}
@keyframes glow { 0%,100%{box-shadow:0 0 20px rgba(196,168,255,.15);} 50%{box-shadow:0 0 50px rgba(196,168,255,.5);} }
.logo-title {
  font-size:2.8rem; font-weight:800; letter-spacing:-2px;
  background:linear-gradient(130deg,var(--p),var(--pk),var(--b));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
}
.logo-sub { font-family:var(--mono); font-size:.58rem; letter-spacing:4px; color:#5a5070; text-transform:uppercase; }
.intro-card {
  width:100%; max-width:340px;
  background:rgba(255,255,255,.04); border:1px solid rgba(196,168,255,.12);
  border-radius:18px; padding:1.4rem 1.5rem;
}
.ic-title { font-family:var(--mono); font-size:.56rem; letter-spacing:3px; color:var(--p); text-transform:uppercase; margin-bottom:1rem; }
.ic-row { display:flex; gap:.9rem; align-items:flex-start; padding:.5rem 0; border-bottom:1px solid rgba(255,255,255,.04); }
.ic-row:last-child { border-bottom:none; }
.ic-icon { font-size:1.3rem; flex-shrink:0; margin-top:1px; }
.ic-text { font-size:.8rem; color:#b0a0c8; line-height:1.45; }
.ic-text strong { color:#f0e8ff; }
.btn-start {
  width:100%; max-width:340px;
  background:linear-gradient(135deg,var(--p),#8858e8);
  border:none; border-radius:16px; padding:1.05rem;
  font-family:var(--sans); font-size:1rem; font-weight:800; color:#07070f;
  cursor:pointer; box-shadow:0 8px 32px rgba(196,168,255,.3); transition:transform .13s;
}
.btn-start:active { transform:scale(.97); }

/* HUD */
#hud {
  position:fixed; top:0; left:0; right:0; z-index:50;
  display:none; align-items:center; justify-content:space-between;
  padding:.85rem 1.1rem;
  background:linear-gradient(to bottom,rgba(7,7,15,.8) 0%,transparent 100%);
}
#hud.on { display:flex; }
.hud-logo {
  font-weight:800; font-size:1.05rem;
  background:linear-gradient(90deg,var(--p),var(--pk));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
}
.hud-badge {
  display:flex; align-items:center; gap:.4rem;
  background:rgba(7,7,15,.75); border:1px solid rgba(196,168,255,.2);
  border-radius:20px; padding:.25rem .75rem;
  font-family:var(--mono); font-size:.56rem; color:var(--p); letter-spacing:1.5px;
  backdrop-filter:blur(8px); cursor:pointer;
}
.live-dot { width:6px; height:6px; border-radius:50%; background:var(--g); animation:blink 1.6s ease-in-out infinite; }
@keyframes blink { 0%,100%{opacity:1;} 50%{opacity:.2;} }

/* CANVAS for lines */
#line-canvas { position:fixed; inset:0; z-index:25; pointer-events:none; }

/* SCANLINE */
#scanline { position:fixed; left:0; right:0; height:1px; z-index:20; display:none;
  background:linear-gradient(90deg,transparent,rgba(196,168,255,.55),transparent);
  animation:scanmove 5s linear infinite; pointer-events:none; }
#scanline.on { display:block; }
@keyframes scanmove { from{top:-1px} to{top:100vh} }
.corner { position:fixed; width:22px; height:22px; z-index:20; pointer-events:none; display:none; }
.corner.on { display:block; }
.corner::before,.corner::after { content:''; position:absolute; background:rgba(196,168,255,.45); }
.ctL{top:.9rem;left:.9rem} .ctL::before{top:0;left:0;width:2px;height:100%} .ctL::after{top:0;left:0;width:100%;height:2px}
.ctR{top:.9rem;right:.9rem} .ctR::before{top:0;right:0;width:2px;height:100%} .ctR::after{top:0;right:0;width:100%;height:2px}
.cbL{bottom:6.5rem;left:.9rem} .cbL::before{bottom:0;left:0;width:2px;height:100%} .cbL::after{bottom:0;left:0;width:100%;height:2px}
.cbR{bottom:6.5rem;right:.9rem} .cbR::before{bottom:0;right:0;width:2px;height:100%} .cbR::after{bottom:0;right:0;width:100%;height:2px}

/* AI OVERLAY */
#ai-overlay {
  position:fixed; inset:0; z-index:200; display:none;
  flex-direction:column; align-items:center; justify-content:center;
  background:rgba(7,7,15,.88); gap:1rem; pointer-events:none;
}
#ai-overlay.on { display:flex; }
.ai-ring { width:72px; height:72px; border-radius:50%; border:3px solid transparent;
  border-top-color:var(--p); border-right-color:var(--pk); animation:spin 1s linear infinite; }
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
.ai-text { font-family:var(--mono); font-size:.68rem; color:var(--p); letter-spacing:3px; text-transform:uppercase; }
.ai-sub { font-size:.75rem; color:#5a5070; }

/* FORMULA BUBBLE */
.fbubble {
  position:fixed; z-index:40;
  background:rgba(7,7,15,.84); border-radius:16px;
  padding:.9rem 1.1rem .8rem 1rem;
  backdrop-filter:blur(22px) saturate(1.5); -webkit-backdrop-filter:blur(22px) saturate(1.5);
  border:1px solid rgba(255,255,255,.1); max-width:205px; min-width:145px;
  box-shadow:0 12px 40px rgba(0,0,0,.6);
  animation:bubIn .45s cubic-bezier(.34,1.56,.64,1) forwards;
  cursor:grab; touch-action:none;
}
.fbubble.dragging { cursor:grabbing; box-shadow:0 20px 60px rgba(0,0,0,.75); transition:none; }
@keyframes bubIn { from{opacity:0;transform:scale(.6) translateY(8px);} to{opacity:1;transform:scale(1) translateY(0);} }
.fb-close {
  position:absolute; top:6px; right:8px; font-size:.75rem; color:#fff;
  opacity:.3; cursor:pointer; width:18px; height:18px;
  display:flex; align-items:center; justify-content:center;
  border-radius:50%; transition:opacity .2s, background .2s;
}
.fb-close:hover { opacity:1; background:rgba(255,60,60,.25); }
.fb-obj { font-family:var(--mono); font-size:.5rem; letter-spacing:2.5px; text-transform:uppercase; opacity:.65; margin-bottom:.2rem; }
.fb-name { font-size:.72rem; font-weight:700; color:#f0e8ff; margin-bottom:.05rem; }
.fb-eq { font-family:var(--mono); font-size:1.15rem; font-weight:700; margin:.3rem 0; animation:eqglow 3s ease-in-out infinite; }
@keyframes eqglow { 0%,100%{text-shadow:none;} 50%{text-shadow:0 0 16px currentColor;} }
.fb-desc { font-size:.63rem; color:#9080b0; line-height:1.45; }

/* TOOLBAR */
#toolbar {
  position:fixed; bottom:0; left:0; right:0; z-index:50; display:none;
  padding:.6rem .8rem 1.3rem;
  background:linear-gradient(to top,rgba(7,7,15,.95) 55%,transparent 100%);
}
#toolbar.on { display:block; }
.tb-hint { font-family:var(--mono); font-size:.5rem; letter-spacing:2.5px; color:#3a3050; text-transform:uppercase; text-align:center; margin-bottom:.5rem; }
.tb-row { display:flex; gap:.4rem; overflow-x:auto; scrollbar-width:none; }
.tb-row::-webkit-scrollbar{display:none;}
.tb-btn {
  flex-shrink:0; display:flex; flex-direction:column; align-items:center; gap:.28rem;
  background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.07);
  border-radius:13px; padding:.6rem .8rem; cursor:pointer; transition:all .18s; min-width:65px;
}
.tb-btn:active { transform:scale(.93); }
.tb-icon { font-size:1.3rem; }
.tb-lbl { font-family:var(--mono); font-size:.48rem; letter-spacing:.5px; color:#6050a0; text-align:center; white-space:nowrap; }

/* ERROR */
#err { position:fixed; inset:0; z-index:400; background:var(--bg); display:none;
  flex-direction:column; align-items:center; justify-content:center; gap:1rem; padding:2rem; text-align:center; }
#err.on { display:flex; }
.err-icon{font-size:3rem} .err-title{font-size:1.2rem;font-weight:800;color:#f0e8ff}
.err-msg{font-size:.8rem;color:#7060a0;line-height:1.65;max-width:300px}
.err-code{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:.9rem 1.1rem;font-family:var(--mono);font-size:.65rem;color:#9080b0;line-height:1.8;max-width:300px;text-align:left;}
.err-btn{background:rgba(196,168,255,.1);border:1px solid rgba(196,168,255,.25);border-radius:12px;padding:.7rem 1.6rem;font-family:var(--mono);font-size:.7rem;color:var(--p);cursor:pointer;letter-spacing:1px;}
</style>
</head>
<body>

<video id="video" autoplay playsinline muted></video>
<canvas id="line-canvas"></canvas>

<!-- SPLASH -->
<div id="splash">
  <div style="display:flex;flex-direction:column;align-items:center;gap:.45rem">
    <div class="logo-ring">‚àë</div>
    <div class="logo-title">MathAR</div>
    <div class="logo-sub">AI ¬∑ Fotocamera ¬∑ Formule Vive</div>
  </div>
  <div class="intro-card">
    <div class="ic-title">Come funziona</div>
    <div class="ic-row"><div class="ic-icon">ü§ñ</div><div class="ic-text"><strong>L'AI analizza</strong> la scena inquadrata e riconosce gli oggetti</div></div>
    <div class="ic-row"><div class="ic-icon">‚ú®</div><div class="ic-text"><strong>Le formule appaiono</strong> collegate all'oggetto con una linea animata</div></div>
    <div class="ic-row"><div class="ic-icon">‚úã</div><div class="ic-text"><strong>Trascina e pizzica</strong> le formule dove vuoi</div></div>
    <div class="ic-row"><div class="ic-icon">üîÅ</div><div class="ic-text"><strong>Tocca "SCANSIONA"</strong> per analizzare di nuovo la scena</div></div>
  </div>
  <button class="btn-start" onclick="startAR()">üì∑ &nbsp;Avvia MathAR</button>
</div>

<!-- ERROR -->
<div id="err">
  <div class="err-icon">üîí</div>
  <div class="err-title">Fotocamera bloccata</div>
  <div class="err-msg">Apri questo link dal tuo telefono tramite GitHub Pages (HTTPS):</div>
  <div class="err-code"><span style="color:var(--p)">IL TUO LINK:</span><br>edilorenzo700-droid<br>.github.io/mathar</div>
  <button class="err-btn" onclick="location.reload()">‚Üª Riprova</button>
</div>

<!-- HUD -->
<div id="hud">
  <div class="hud-logo">MathAR</div>
  <div class="hud-badge" onclick="triggerAIScan()">
    <div class="live-dot"></div>
    <span id="hud-txt">SCANSIONA</span>
  </div>
</div>

<!-- AI overlay -->
<div id="ai-overlay">
  <div class="ai-ring"></div>
  <div class="ai-text">ANALISI AI</div>
  <div class="ai-sub" id="ai-sub">Riconosco gli oggetti...</div>
</div>

<!-- Corners + scanline -->
<div id="scanline"></div>
<div class="corner ctL on"></div><div class="corner ctR on"></div>
<div class="corner cbL on"></div><div class="corner cbR on"></div>

<!-- TOOLBAR -->
<div id="toolbar">
  <div class="tb-hint">+ aggiungi formula manualmente</div>
  <div class="tb-row" id="tb-row"></div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DATABASE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DB = {
  lamp: { icon:'üí°', label:'Lampada ¬∑ Luce', color:'#ffd080', objects:['lamp','light','bulb','chandelier','ceiling light','lantern','spotlight'],
    formulas:[
      { name:'Intensit√† luminosa', eq:'I = P / 4œÄr¬≤', desc:'Diminuisce col quadrato della distanza' },
      { name:'Velocit√† della luce', eq:'c = Œª ¬∑ f', desc:'Lunghezza d\'onda √ó frequenza' },
      { name:'Legge di Snell', eq:'n‚ÇÅsinŒ∏‚ÇÅ=n‚ÇÇsinŒ∏‚ÇÇ', desc:'Rifrazione tra due mezzi' },
    ]
  },
  window_: { icon:'ü™ü', label:'Finestra ¬∑ Vetro', color:'#8dd8ff', objects:['window','glass','door','frame','curtain','opening'],
    formulas:[
      { name:'Indice di rifrazione', eq:'n = c / v', desc:'Rapporto velocit√† luce/vetro' },
      { name:'Angolo critico', eq:'Œ∏_c = arcsin(1/n)', desc:'Oltre: riflessione totale interna' },
      { name:'Trasmittanza', eq:'T = I_t / I‚ÇÄ', desc:'Frazione di luce trasmessa' },
    ]
  },
  table: { icon:'ü™ë', label:'Superficie', color:'#80ffcc', objects:['table','desk','chair','floor','surface','furniture','sofa','couch','shelf','bookshelf','counter','bench'],
    formulas:[
      { name:'Area rettangolo', eq:'A = b √ó h', desc:'Base √ó altezza' },
      { name:'Forza d\'attrito', eq:'f = Œº ¬∑ N', desc:'Œº = coeff. attrito statico/dinamico' },
      { name:'Pressione', eq:'P = F / A', desc:'Forza distribuita su area' },
    ]
  },
  person: { icon:'üßë', label:'Corpo umano', color:'#ff9fd4', objects:['person','man','woman','human','face','body','people','student','teacher','hand'],
    formulas:[
      { name:'II Legge di Newton', eq:'F = m ¬∑ a', desc:'Forza = massa √ó accelerazione' },
      { name:'Energia cinetica', eq:'E‚Çñ = ¬Ωmv¬≤', desc:'Energia del corpo in movimento' },
      { name:'Momento angolare', eq:'L = I ¬∑ œâ', desc:'Inerzia √ó velocit√† angolare' },
    ]
  },
  book: { icon:'üìö', label:'Libro ¬∑ Schermo', color:'#c4a8ff', objects:['book','notebook','paper','laptop','computer','screen','monitor','keyboard','tablet','phone'],
    formulas:[
      { name:'Identit√† di Eulero', eq:'e^(iœÄ)+1=0', desc:'La pi√π bella formula della matematica' },
      { name:'Formula quadratica', eq:'x=(-b¬±‚àöŒî)/2a', desc:'Œî = b¬≤ ‚àí 4ac' },
      { name:'Derivata', eq:'f\'(x)=lim[f(x+h)-f(x)]/h', desc:'h‚Üí0: tasso di variazione istantaneo' },
    ]
  },
  wall: { icon:'üß±', label:'Muro ¬∑ Spazio', color:'#ffd080', objects:['wall','ceiling','floor','building','room','corner','architecture','brick'],
    formulas:[
      { name:'Teorema di Pitagora', eq:'a¬≤ + b¬≤ = c¬≤', desc:'Triangolo rettangolo' },
      { name:'Teorema di Tales', eq:'AB/DE = BC/EF', desc:'Triangoli simili: lati proporzionali' },
      { name:'Area triangolo', eq:'A = ¬Ω ¬∑ b ¬∑ h', desc:'Base √ó altezza / 2' },
    ]
  },
  sky: { icon:'üå§', label:'Cielo ¬∑ Aria', color:'#8dd8ff', objects:['sky','cloud','outdoor','outside','tree','plant','nature','window','atmosphere'],
    formulas:[
      { name:'Gas perfetti', eq:'PV = nRT', desc:'Pressione, volume, temperatura, moli' },
      { name:'Velocit√† del suono', eq:'v = ‚àö(Œ≥RT/M)', desc:'Dipende da T e composizione' },
      { name:'Pressione atm.', eq:'P = œÅ¬∑g¬∑h', desc:'Colonna d\'aria sovrastante' },
    ]
  },
  default: { icon:'‚ú®', label:'Fenomeno fisico', color:'#c4a8ff', objects:[],
    formulas:[
      { name:'Einstein', eq:'E = mc¬≤', desc:'Energia e massa equivalenti' },
      { name:'Gravitazione', eq:'F=Gm‚ÇÅm‚ÇÇ/r¬≤', desc:'Attrazione universale tra masse' },
      { name:'Equazione d\'onda', eq:'‚àÇ¬≤y/‚àÇt¬≤=v¬≤‚àÇ¬≤y/‚àÇx¬≤', desc:'Propagazione di onde' },
    ]
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let bubbles = [], zTop = 30;
const canvas = document.getElementById('line-canvas');
const ctx = canvas.getContext('2d');

function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê START AR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startAR() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ ideal:'environment' }, width:{ ideal:1920 }, height:{ ideal:1080 } },
      audio:false
    });
    const vid = document.getElementById('video');
    vid.srcObject = stream;
    vid.style.transform = 'none';
    await vid.play();

    document.getElementById('splash').classList.add('out');
    setTimeout(() => document.getElementById('splash').style.display='none', 650);
    document.getElementById('hud').classList.add('on');
    document.getElementById('toolbar').classList.add('on');
    document.getElementById('scanline').classList.add('on');

    buildToolbar();
    drawLines();
    setTimeout(triggerAIScan, 1200);
  } catch(e) {
    console.error(e);
    document.getElementById('err').classList.add('on');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI SCAN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function triggerAIScan() {
  const ov = document.getElementById('ai-overlay');
  const sub = document.getElementById('ai-sub');
  ov.classList.add('on');
  ov.style.pointerEvents = 'all';
  sub.textContent = 'Scatto il fotogramma...';
  document.getElementById('hud-txt').textContent = 'ANALISI...';

  const vid = document.getElementById('video');
  const snap = document.createElement('canvas');
  snap.width = Math.min(vid.videoWidth || 640, 640);
  snap.height = Math.min(vid.videoHeight || 480, 480);
  snap.getContext('2d').drawImage(vid, 0, 0, snap.width, snap.height);
  const b64 = snap.toDataURL('image/jpeg', 0.75).split(',')[1];

  sub.textContent = 'AI in analisi...';

  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:200,
        messages:[{
          role:'user',
          content:[
            { type:'image', source:{ type:'base64', media_type:'image/jpeg', data:b64 } },
            { type:'text', text:'List ONLY the main objects you see in this room image. Reply with ONLY a comma-separated list of object names in English (max 6 items). No other text. Example: table, lamp, window, book, person, wall' }
          ]
        }]
      })
    });
    const data = await resp.json();
    const raw = data.content?.[0]?.text || '';
    const detected = raw.toLowerCase().split(',').map(s=>s.trim()).filter(Boolean);
    console.log('Detected:', detected);
    ov.classList.remove('on');
    ov.style.pointerEvents = 'none';
    processDetections(detected);
  } catch(e) {
    console.error(e);
    ov.classList.remove('on');
    ov.style.pointerEvents = 'none';
    processDetections(['table','window','lamp']);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROCESS DETECTIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function processDetections(detected) {
  const matched = new Set();
  detected.forEach(word => {
    Object.entries(DB).forEach(([key, cat]) => {
      if (key==='default') return;
      if (cat.objects.some(o => word.includes(o) || o.includes(word))) matched.add(key);
    });
  });
  if (matched.size===0) matched.add('default');

  // Remove old bubbles
  bubbles.forEach(b => b.el?.remove());
  bubbles = [];

  const keys = [...matched].slice(0, 4);
  const vw = window.innerWidth, vh = window.innerHeight;
  const positions = [
    {x:vw*.07, y:vh*.12}, {x:vw*.48, y:vh*.10},
    {x:vw*.05, y:vh*.48}, {x:vw*.5,  y:vh*.50},
  ];
  // Origins spread across the middle of the screen
  const origins = [
    {x:vw*.25, y:vh*.5}, {x:vw*.6, y:vh*.45},
    {x:vw*.3,  y:vh*.65},{x:vw*.65, y:vh*.65},
  ];

  keys.forEach((key, i) => {
    const cat = DB[key];
    const f = cat.formulas[i % cat.formulas.length];
    spawnBubble(f, cat, positions[i]||{x:vw*.2,y:vh*.2}, origins[i]||{x:vw*.5,y:vh*.5});
  });

  document.getElementById('hud-txt').textContent = `${keys.length} OGGETTI`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SPAWN BUBBLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function spawnBubble(formula, cat, pos, origin) {
  const el = document.createElement('div');
  el.className = 'fbubble';
  el.style.cssText = `left:${pos.x}px;top:${pos.y}px;z-index:${++zTop};border-color:${cat.color}35;box-shadow:0 12px 40px rgba(0,0,0,.6),0 0 0 1px ${cat.color}20;`;
  el.innerHTML = `
    <div class="fb-close" onclick="removeBubble(this.parentNode)">‚úï</div>
    <div class="fb-obj" style="color:${cat.color}bb;">${cat.icon} ${cat.label}</div>
    <div class="fb-name">${formula.name}</div>
    <div class="fb-eq" style="color:${cat.color}">${formula.eq}</div>
    <div class="fb-desc">${formula.desc}</div>
  `;
  document.body.appendChild(el);
  const b = { el, x:pos.x, y:pos.y, ox:origin.x, oy:origin.y, color:cat.color };
  bubbles.push(b);
  makeDraggable(el, b);
  makePinchable(el);
  return b;
}

function removeBubble(el) {
  el.style.transition='opacity .3s,transform .3s'; el.style.opacity='0'; el.style.transform='scale(.6)';
  setTimeout(()=>{ el.remove(); bubbles=bubbles.filter(b=>b.el!==el); }, 300);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DRAW LINES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawLines() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const t = performance.now();
  bubbles.forEach(b => {
    if (!b.el?.isConnected) return;
    const r = b.el.getBoundingClientRect();
    const bx = r.left + r.width/2, by = r.top + r.height/2;

    // Dashed animated line
    ctx.save();
    ctx.setLineDash([4,8]);
    ctx.lineDashOffset = -(t/40);
    ctx.strokeStyle = b.color+'55';
    ctx.lineWidth = 1.2;
    ctx.beginPath(); ctx.moveTo(b.ox,b.oy); ctx.lineTo(bx,by); ctx.stroke();

    // Dot at origin
    ctx.setLineDash([]);
    ctx.fillStyle = b.color+'cc';
    ctx.beginPath(); ctx.arc(b.ox,b.oy,5,0,Math.PI*2); ctx.fill();

    // Expanding ripple
    const phase = (t%2000)/2000;
    const rAlpha = Math.floor((1-phase)*160).toString(16).padStart(2,'0');
    ctx.strokeStyle = b.color+rAlpha;
    ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.arc(b.ox,b.oy,phase*30,0,Math.PI*2); ctx.stroke();

    ctx.restore();
  });
  requestAnimationFrame(drawLines);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DRAG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function makeDraggable(el, bubble) {
  let d=false, sx,sy,il,it;
  const dn = e => {
    if(e.target.classList.contains('fb-close')) return;
    d=true; el.classList.add('dragging'); el.style.zIndex=++zTop;
    const t=e.touches?e.touches[0]:e; sx=t.clientX; sy=t.clientY;
    il=parseFloat(el.style.left)||0; it=parseFloat(el.style.top)||0;
    e.preventDefault();
  };
  const mv = e => {
    if(!d) return;
    const t=e.touches?e.touches[0]:e;
    el.style.left=(il+t.clientX-sx)+'px'; el.style.top=(it+t.clientY-sy)+'px';
    if(bubble){bubble.x=parseFloat(el.style.left);bubble.y=parseFloat(el.style.top);}
    e.preventDefault();
  };
  const up = ()=>{ d=false; el.classList.remove('dragging'); };
  el.addEventListener('touchstart',dn,{passive:false});
  el.addEventListener('touchmove',mv,{passive:false});
  el.addEventListener('touchend',up);
  el.addEventListener('mousedown',dn);
  window.addEventListener('mousemove',mv);
  window.addEventListener('mouseup',up);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PINCH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function makePinchable(el) {
  let id=null, is=1;
  el.addEventListener('touchstart',e=>{ if(e.touches.length===2){id=dist(e.touches);is=getS(el);} },{passive:true});
  el.addEventListener('touchmove',e=>{ if(e.touches.length===2&&id){ const s=Math.max(.4,Math.min(3,is*dist(e.touches)/id)); el.style.transform=`scale(${s})`; } },{passive:true});
  el.addEventListener('touchend',()=>id=null);
}
const dist=t=>Math.hypot(t[0].clientX-t[1].clientX,t[0].clientY-t[1].clientY);
const getS=el=>{ const m=(el.style.transform||'').match(/scale\(([^)]+)\)/); return m?+m[1]:1; };

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOOLBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildToolbar() {
  const row = document.getElementById('tb-row');
  Object.entries(DB).forEach(([key,cat]) => {
    const btn = document.createElement('div');
    btn.className='tb-btn'; btn.style.borderColor=cat.color+'30';
    btn.innerHTML=`<div class="tb-icon">${cat.icon}</div><div class="tb-lbl" style="color:${cat.color}">${cat.label.split('¬∑')[0].trim()}</div>`;
    btn.addEventListener('pointerdown',()=>{
      const vw=window.innerWidth,vh=window.innerHeight;
      const f=cat.formulas[Math.floor(Math.random()*cat.formulas.length)];
      spawnBubble(f,cat,{x:vw*.15+Math.random()*vw*.55,y:vh*.15+Math.random()*vh*.35},{x:vw*.5,y:vh*.5});
    });
    row.appendChild(btn);
  });
}

document.addEventListener('touchmove',e=>e.preventDefault(),{passive:false});
</script>
</body>
</html>
